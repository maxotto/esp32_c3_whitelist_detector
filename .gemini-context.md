# Project Context: WhiteListDetector

This document summarizes the key aspects, debugging history, and current architecture of the `WhiteListDetector` ESP-IDF project, as guided by the Gemini CLI agent.

## Project Goal
The primary goal is to implement a system that checks the accessibility of several internet hosts (Google, Dzen, KP40) and reports an overall internet status (`FULL_ACCESS`, `RF_SITES_ONLY`, `WHITE_LIST`, `NO_INTERNET`) by controlling an RGB LED strip. The system connects to a WiFi network.

## Key Information & Agent Permissions
*   **ESP-IDF Version:** v5.5.1 (explicitly noted in `sdkconfig` file).
*   **Agent Permissions:** The user has granted permission to read all ignored files (e.g., `.gitignore`, `.vscode/c_cpp_properties.json`), which was crucial for debugging build and IntelliSense issues.

## Key Components
*   **main.cpp**: Contains the monolithic application logic, including WiFi connection handling, ping execution, internet status determination, and LED strip control.
*   **WiFiController Component**: A C++ class (`components/wifi_controller/`) encapsulating standard ESP-IDF WiFi station mode initialization and connection management.
*   **led_strip Component**: An official ESP-IDF component for controlling WS2812B (NeoPixel) LED strips via the RMT peripheral.

## Debugging History & Solutions

### 1. Initial Ping Failures (`E (X) ping_sock: send error=0`)
*   **Problem:** Subsequent pings failed with `send error=0` due to resource leaks/race conditions in the `esp_ping` API.
*   **Attempts & Solutions:**
    *   **Pinger Class Abstraction:** Initially, a `Pinger` class was created to encapsulate ping logic, with `esp_ping_delete_session` in the `on_ping_end` callback (as per some ESP-IDF examples). This led to crashes.
    *   **Heap Allocation:** Moved `Pinger` instances from stack to heap to resolve stack overflow-related crashes.
    *   **Explicit Session Deletion:** Moved `esp_ping_delete_session` back to the main execution flow (`Pinger::ping` method) after the semaphore wait, while `on_ping_end` only gave the semaphore. This stabilized the `Pinger` class.
    *   **`CONFIG_LWIP_TCPIP_CORE_LOCKING`:** Enabled this `sdkconfig` option to ensure thread-safety for lwIP operations performed across different tasks. This was a critical step for stability.
    *   **Explicit Interface Setting:** Attempted to explicitly set the network interface for ping (`ping_config.interface`). This introduced compilation errors due to API version mismatches and eventually a regression where *no* pings worked. This change was reverted, relying on the default interface assignment.
    *   **Conclusion:** The `Pinger` class implementation was eventually abandoned in favor of direct, minimal C++ translation of an official ESP-IDF `ping` example.

### 2. WiFi Instability & Power Concerns
*   **Problem:** Persistent `send error=0` even after code stabilization, often accompanied by unstable WiFi connections (disconnects, low RSSI).
*   **Attempts & Solutions:**
    *   **Delay before Ping:** Added a `vTaskDelay` before the first ping to allow the network stack to stabilize (later removed as `main.cpp` already waited for connection).
    *   **Reduced WiFi TX Power (50%):** User initially requested this to mitigate power supply issues from USB. This setting was preserved.
    *   **Reduced CPU Frequency (80MHz):** Attempted to lower CPU frequency in `sdkconfig` to reduce overall power consumption, but the `sdkconfig` change was not applied correctly. This was not pursued further once the minimal example started working.
    *   **Conclusion:** The `send error=0` was eventually resolved when the project reverted to a monolithic `main.cpp` based on a minimal working example, suggesting the underlying issue was indeed complex concurrency within previous abstractions rather than solely power.

### 3. `led_strip` Component Integration
*   **Problem:** Initial attempts to integrate `led_strip` (NeoPixel) component.
*   **Solutions:**
    *   **Component Manager:** The `led_strip` component was added as a managed dependency (`espressif/led_strip`) via `main/idf_component.yml`, which is the correct way for ESP-IDF v5+.
    *   **API Version Mismatch:** Encountered multiple compilation errors due to `led_strip` API differences. The code was adapted to use the older, function-pointer-based API (`led_strip_new_rmt_device`, `led_strip_set_pixel` with manual GRB swap, etc.) that is compatible with the project's environment.

## Current Architecture
*   **Monolithic `main.cpp`:** Contains all the core application logic: WiFi setup, synchronous ping execution, internet status determination, and LED control. This simplified structure proved essential for resolving deep-seated ping-related issues.
*   **`WiFiController` component:** Contains the `WiFiController` C++ class for managing WiFi connection.
*   **`led_strip` component:** Integrated via component manager for LED control.

## To-Do / Future Enhancements
*   (Currently, the task is complete for the user's request, no further enhancements were explicitly requested beyond the current state.)

This context file captures the journey and reasoning behind the current state of the project.